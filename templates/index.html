<!DOCTYPE html>
<html>
<head>
<title>NOC Dashboard</title>
<meta charset="UTF-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background:#0b1220; color:white; }
.card { background:#1c2536; color:white; }
.status-online { color:#22c55e; font-weight:bold; }
.status-offline { color:#ef4444; font-weight:bold; }
.status-maintenance { color:#facc15; font-weight:bold; }

#incidentBanner {
  display:none;
  background:#b91c1c;
  padding:15px;
  font-weight:bold;
  animation: blink 1s infinite;
}
@keyframes blink {
  50% { opacity:0.4; }
}
</style>
</head>
<body>

<div class="container mt-3">

<div class="d-flex justify-content-between align-items-center">
<h3>NOC Dashboard</h3>
<div>
<button id="muteBtn" onclick="toggleMute()" class="btn btn-warning btn-sm">
Mute Alarm
</button>
<a href="/logout" class="btn btn-danger btn-sm">Logout</a>
</div>
</div>

<div id="incidentBanner" class="mt-3"></div>

<!-- SUMMARY SECTION -->
<div class="row mt-3 text-center">
<div class="col-md-3">
<div class="card p-3">
<h6>Total</h6>
<h4 id="totalCount">0</h4>
</div>
</div>
<div class="col-md-3">
<div class="card p-3">
<h6>Online</h6>
<h4 id="onlineCount">0</h4>
</div>
</div>
<div class="col-md-3">
<div class="card p-3">
<h6>Offline</h6>
<h4 id="offlineCount">0</h4>
</div>
</div>
<div class="col-md-3">
<div class="card p-3">
<h6>Maintenance</h6>
<h4 id="maintenanceCount">0</h4>
</div>
</div>
</div>

{% if session.role=="admin" %}
<div class="card p-3 mt-4">
<h5>Add Monitor</h5>
<input id="targetName" placeholder="Hostname or IP" class="form-control mb-2">
<select id="monitorType" class="form-control mb-2">
<option value="icmp">ICMP</option>
<option value="tcp">TCP</option>
</select>
<input id="monitorPort" placeholder="TCP Port (if TCP)" class="form-control mb-2">
<button onclick="addTarget()" class="btn btn-primary">Add</button>
</div>
{% endif %}

<hr>

<table class="table table-dark table-striped">
<thead>
<tr>
<th>Host</th>
<th>Check</th>
<th>Status</th>
<th>Maintenance</th>
<th>Remove</th>
</tr>
</thead>
<tbody id="deviceTable"></tbody>
</table>

<hr>

<div class="card p-3">
<div class="d-flex justify-content-between">
<h5>Incident History</h5>
{% if session.role=="admin" %}
<button onclick="clearIncidents()" class="btn btn-sm btn-danger">
Clear History
</button>
{% endif %}
</div>
<table class="table table-dark table-sm mt-3">
<thead>
<tr>
<th>Host</th>
<th>Check</th>
<th>Down Time</th>
<th>Up Time</th>
<th>Duration</th>
</tr>
</thead>
<tbody id="incidentTable"></tbody>
</table>
</div>

</div>

<audio id="alarmSound" loop>
<source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>

let alarmMuted = false;

function toggleMute(){
  alarmMuted = !alarmMuted;
  document.getElementById("muteBtn").innerText =
    alarmMuted ? "Unmute Alarm" : "Mute Alarm";

  if(alarmMuted){
    document.getElementById("alarmSound").pause();
  }
}

function addTarget(){
 const name=document.getElementById("targetName").value;
 const type=document.getElementById("monitorType").value;
 const port=document.getElementById("monitorPort").value;

 fetch("/add",{
   method:"POST",
   headers:{"Content-Type":"application/x-www-form-urlencoded"},
   body:`name=${encodeURIComponent(name)}&monitor_type=${type}&monitor_port=${port}`
 }).then(()=>{
   document.getElementById("targetName").value="";
   document.getElementById("monitorPort").value="";
   refresh();
 });
}

function removeTarget(id){
 fetch("/remove/"+id,{method:"POST"})
 .then(()=>refresh());
}

function toggleMaintenance(id){
 fetch("/toggle_maintenance/"+id,{method:"POST"})
 .then(()=>refresh());
}

function clearIncidents(){
 fetch("/clear_incidents",{method:"POST"})
 .then(()=>loadIncidents());
}

function refresh(){

 fetch("/status").then(r=>r.json()).then(data=>{

   let html="";
   let offlineList=[];
   let total=0, online=0, offline=0, maintenance=0;

   data.forEach(d=>{
     total++;

     let detail = d.monitor_type==="tcp" ?
       "TCP:"+d.monitor_port : "ICMP";

     if(d.maintenance==1){
        maintenance++;
     } else if(d.status==="Online"){
        online++;
     } else {
        offline++;
        offlineList.push(d.name+" ("+detail+")");
     }

     html+=`<tr>
       <td>${d.name}</td>
       <td>${detail}</td>
       <td class="${
         d.maintenance==1 ? 'status-maintenance' :
         d.status==='Online' ? 'status-online' : 'status-offline'
       }">
         ${d.maintenance==1 ? "Maintenance" : d.status}
       </td>
       <td>
         {% if session.role=="admin" %}
         <button onclick="toggleMaintenance(${d.id})"
           class="btn btn-sm ${d.maintenance==1?'btn-warning':'btn-secondary'}">
           ${d.maintenance==1?'ON':'OFF'}
         </button>
         {% else %}
         ${d.maintenance==1?'ON':'OFF'}
         {% endif %}
       </td>
       <td>
         {% if session.role=="admin" %}
         <button onclick="removeTarget(${d.id})"
           class="btn btn-sm btn-danger">Remove</button>
         {% endif %}
       </td>
     </tr>`;
   });

   document.getElementById("deviceTable").innerHTML=html;

   document.getElementById("totalCount").innerText = total;
   document.getElementById("onlineCount").innerText = online;
   document.getElementById("offlineCount").innerText = offline;
   document.getElementById("maintenanceCount").innerText = maintenance;

   // ---- BANNER LOGIC ----
   if(offlineList.length>0){
     document.getElementById("incidentBanner").style.display="block";
     document.getElementById("incidentBanner").innerText =
       "INCIDENT ACTIVE - DEVICE OFFLINE: " + offlineList.join(", ");

     if(!alarmMuted){
       document.getElementById("alarmSound").play();
     }
   } else {
     document.getElementById("incidentBanner").style.display="none";
     document.getElementById("alarmSound").pause();
   }

 });

 loadIncidents();
}

function loadIncidents(){
 fetch("/incidents").then(r=>r.json()).then(data=>{
   let html="";
   data.forEach(i=>{
     html+=`<tr>
       <td>${i.target}</td>
       <td>${i.monitor_detail}</td>
       <td>${i.down_time||""}</td>
       <td>${i.up_time||""}</td>
       <td>${i.duration||""}</td>
     </tr>`;
   });
   document.getElementById("incidentTable").innerHTML=html;
 });
}

setInterval(refresh,5000);
refresh();

</script>
</body>
</html>
